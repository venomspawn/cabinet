# Нечёткий поиск записей

Сервис поддерживает нечёткий поиск записей по заранее предопределённым полям:

*   имя, фамилия, отчество и место рождения для записи физического лица;
*   имя, фамилия, отчество и место рождения для записи индивидуального
    предпринимателя;
*   полное название для записи юридического лица.

Нечёткий поиск осуществляется с помощью средств, предоставляемых расширением
`pg_trgm` СУБД PostgreSQL. Основным алгоритмом является сравнение совпадающих
триграм значений полей и параметров поиска. Для ускорения поиска используется
массивное индексирование по указанным выше полям и отсечение записей с малыми
показателями по каждому из используемых полей. Поскольку исходный алгоритм
нельзя непосредственно использовать для сравнения нескольких значений
одновременно, в случае поиска записей физических лиц и индивидуальных
предпринимателей используется сортировка по возрастанию значений линейной
комбинации следующего вида:

```
C_имя * К_имя + С_фамилия * К_фамилия + С_отчество * К_отчество +
  + С_место_рождения * К_место_рождения
```

где `С_*` — числовые показатели сходства соответствующих значений полей и
параметров, а `К_*` — вещественные положительные числа. Отсюда следует, что чем
меньше числа `K_*`, тем меньшее сходство допускается для соответствующих
значений. Настройка чисел `K_*` вынесена в файла `config/04_fuzzy.rb`.
Настройка отсечения отсутствует на уровне сервиса, по умолчанию отсекаются
записи, у которых хотя бы один из числовых показателей сходства меньше `0.3`
(см. документацию PostgreSQL по `pg_trgm`).
